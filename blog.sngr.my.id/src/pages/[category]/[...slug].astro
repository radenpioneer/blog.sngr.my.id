---
import type { GetStaticPaths } from 'astro'
import { getCollection } from 'astro:content'
import { getImage } from 'astro:assets'
import Layout from '~/layouts/layout.astro'
import { getExcerpt } from '~/utils/excerpt'

export const getStaticPaths = (async () => {
  const posts = await getCollection('posts')
  return posts.map((post) => {
    const cat = post.data.category
    const year = new Date(post.data.date).getFullYear()
    return {
      params: {
        category: cat.id,
        slug: `${year}/${post.slug}`,
      },
      props: { post, cat },
    }
  })
}) satisfies GetStaticPaths

const { post } = Astro.props
const { Content } = await post.render()
const image = post.data.image
  ? await getImage({ src: post.data.image, width: 768, height: 432 })
  : null
---

<Layout
  title={post.data.title}
  description={post.data.description ||
    (getExcerpt(post.body, 'string') as string)}
  hidden={(post.data.hidden as boolean) || false}
>
  <Fragment slot="head">
    {image && <link rel="preload" href={image.src} as="image" />}
  </Fragment>
  <section class="max-w-screen-md mx-auto">
    <article class="prose prose-lg max-w-none">
      <hgroup class="not-prose flex flex-col gap-4">
        <h1 class="font-extrabold text-4xl">{post.data.title}</h1>
        {
          image && (
            <img
              src={image.src}
              class="aspect-[16/9] object-cover"
              {...image.attributes}
              loading="eager"
              alt={post.data.title}
            />
          )
        }
      </hgroup>
      <Content />
    </article>
  </section>
</Layout>
